---
title: 一个改变的key引发的问题
date: 2021-04-04 12:25:50
tags: bug
categories: 笔记
author: yaming042
type: 原创
---

今天闲来无事，忽然想起了前天在开发功能时遇到的一个问题，具体情况就是我渲染了一个邮箱列表，列表支持修改邮箱，但是发现每次改完邮箱后input框就会失去焦点，按理说input是不会失去焦点的，但bug就此发生了。
___
![邮件列表](email.png)
___
需要渲染的邮箱列表数据格式 <code>['xiaoming@163.com','lier@163.com']</code>，渲染的列表支持修改，代码如下:
```javascript
render(){
    let { emails } = this.state;

    return (
        <div className="container">
            {
                (emails || []).map((email, index) => {
                    return (
                        <div className="email-row" key={ email }>
                            <input 
                                type="text" 
                                value={ email } 
                                onChange={(e) => {
                                    emails[index] = (e.target.value || '').trim();
                                    this.setState({
                                        emails: emails)
                                    });
                                }}    
                            />
                        </div>
                    );
                })
            }
        </div>
    );
}
```
看完上面是否有发现问题。大体看上去没啥问题，但是在页面上实际测过后你会发现一个bug，每次敲击完键盘，input输入框会失去焦点，那么为什么会发生这种bug呢，其实你回想下react的渲染流程应该就会发现问题。
**先说原因：**因为你每次change后email发生了改变，也就是说，你在渲染列表的时候，列表的 <code>key</code> 发生了改变，此时再次渲染，原来的dom已经被干掉换成新的dom了，只是看起来还是原来的那个input；
**再说处理办法：**慎重定义 <code>key</code> 的值
